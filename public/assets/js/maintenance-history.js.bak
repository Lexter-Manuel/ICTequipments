/* =========================================================
   STATE & DATA
   ========================================================= */
var HIST_DIVISIONS = {};
var HIST_EMPLOYEES = {};
var ALL_ASSETS_FLAT = [];
var activeHistDivisionKey = null;
var activeHistSubtab = 'grouped';

/* =========================================================
   INITIALIZATION (Triggered by dashboard.js SPA)
   ========================================================= */
window.initPage = function() {
    fetchMaintenanceHistory();
};

async function fetchMaintenanceHistory() {
    try {
        var response = await fetch(`${BASE_URL}get_maintenance_history.php`);
        var data = await response.json();
        
        if (data.success) {
            HIST_DIVISIONS = data.divisions;
            HIST_EMPLOYEES = data.employees;
            
            // Flatten assets for the main "Detailed View" table
            ALL_ASSETS_FLAT = [];
            Object.values(HIST_DIVISIONS).forEach(div => {
                ALL_ASSETS_FLAT = ALL_ASSETS_FLAT.concat(div.assets);
            });
            
            // Update Top-level Stats
            updateTopLevelStats(data.summary);
            
            // Populate the Main "Detailed View" Table
            populateMainDetailedTable(ALL_ASSETS_FLAT);
            
            // If currently viewing a division, re-render it
            if (activeHistDivisionKey && HIST_DIVISIONS[activeHistDivisionKey]) {
                renderHistoryDivision();
            }
        } else {
            console.error("Failed to fetch maintenance history:", data.error);
        }
    } catch (error) {
        // console.error("AJAX Fetch Error:", error);
    }
}

function updateTopLevelStats(summary) {
    var statsBar = document.getElementById('histStatsBar');
    if (!statsBar) return;
    
    var totalEl = statsBar.querySelector('.total .mnt-hist-stat-value');
    var maintainedEl = statsBar.querySelector('.maintained .mnt-hist-stat-value');
    var excellentEl = statsBar.querySelector('.excellent .mnt-hist-stat-value');
    var pendingEl = statsBar.querySelector('.pending .mnt-hist-stat-value');
    
    if (totalEl) totalEl.textContent = summary.total;
    if (maintainedEl) maintainedEl.textContent = summary.maintained;
    if (excellentEl) excellentEl.textContent = summary.excellent_good;
    if (pendingEl) pendingEl.textContent = summary.pending;
}

function populateMainDetailedTable(assets) {
    // This replaces the hardcoded <tbody> in your maintenance-history.php
    var tbody = document.querySelector('#history-detailed .mnt-table tbody');
    if (!tbody) return;

    if (!assets.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--text-light); font-style:italic;">No maintenance history records found.</td></tr>`;
        return;
    }

    var iconMap   = { system_unit: 'fa-desktop', laptop: 'fa-laptop', printer: 'fa-print', monitor: 'fa-tv', other: 'fa-server' };
    var typeClass = { system_unit: '', laptop: '', printer: 'type-printer', monitor: 'type-monitor', other: '' };
    var condMap   = { excellent: 'mnt-badge-excellent', good: 'mnt-badge-good', fair: 'mnt-badge-fair', poor: 'mnt-badge-poor' };

    var html = '';
    assets.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(a => {
        var condBadge = condMap[a.condition] || 'mnt-badge-fair';
        html += `
            <tr>
                <td>
                    <div class="mnt-date-primary completed">${a.dateLabel}</div>
                    <div class="mnt-date-sub">${a.time}</div>
                </td>
                <td>
                    <div class="mnt-equip-cell">
                        <div class="mnt-equip-icon ${typeClass[a.type] || ''}"><i class="fas ${iconMap[a.type] || 'fa-desktop'}"></i></div>
                        <div>
                            <div class="mnt-equip-name">${a.name}</div>
                            <div class="mnt-equip-serial">SN: ${a.serial}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <div class="mnt-location-primary">${a.unit}</div>
                </td>
                <td>
                    <div class="mnt-tech-name">${a.tech}</div>
                    <div class="mnt-tech-role">${a.techRole}</div>
                </td>
                <td><span class="mnt-badge ${condBadge}"><i class="fas fa-circle"></i> ${a.conditionLabel}</span></td>
                <td><button class="mnt-btn-report" onclick="viewReport(${a.id})"><i class="fas fa-file-pdf"></i> View</button></td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function switchHistoryView(view) {
    document.getElementById('history-detailed').className = view === 'detailed' ? 'd-block' : 'd-none';
    document.getElementById('history-summary').className  = view === 'summary'  ? 'd-block' : 'd-none';
    document.getElementById('btnHistoryDetailed').classList.toggle('active', view === 'detailed');
    document.getElementById('btnHistorySummary').classList.toggle('active',  view === 'summary');

    document.getElementById('histFilterBar').style.display = view === 'summary' ? 'none' : '';
    document.getElementById('histStatsBar').style.display  = view === 'summary' ? 'none' : '';

    if (view === 'summary') backToDivisionsHistory();
}

/* =========================================================
   OPEN DIVISION VIEW
   ========================================================= */
function viewDivisionHistory(divKey) {
    activeHistDivisionKey = divKey;
    var div = HIST_DIVISIONS[divKey];

    document.getElementById('histDivisionCardsGrid').style.display = 'none';

    document.getElementById('dvHistName').textContent       = div.name;
    document.getElementById('dvHistBreadcrumb').textContent = div.name;

    // Stat badges
    document.getElementById('dvHistBadges').innerHTML = `
        <span class="dv-stat-pill total"><i class="fas fa-layer-group"></i> ${div.stats.total} Total</span>
        <span class="dv-stat-pill maintained"><i class="fas fa-check-circle"></i> ${div.stats.maintained} Maintained</span>
        ${div.stats.pending > 0 ? `<span class="dv-stat-pill pending"><i class="fas fa-hourglass-half"></i> ${div.stats.pending} Pending</span>` : ''}
        <span class="dv-stat-pill compliance"><i class="fas fa-chart-line"></i> ${div.stats.compliance}% Compliance</span>
    `;

    // Populate unit filter
    var unitSel = document.getElementById('dvHistUnitFilter');
    unitSel.innerHTML = '';
    div.units.forEach(u => {
        var opt = document.createElement('option');
        opt.value = u === 'All Units' ? '' : u;
        opt.textContent = u;
        unitSel.appendChild(opt);
    });

    // Reset sub-tab
    activeHistSubtab = 'grouped';
    document.getElementById('dvHistTabGrouped').classList.add('active');
    document.getElementById('dvHistTabAll').classList.remove('active');
    document.getElementById('dvHistTabEmp').classList.remove('active');
    document.getElementById('dvHistPanelGrouped').classList.add('dv-panel-active');
    document.getElementById('dvHistPanelAll').classList.remove('dv-panel-active');
    document.getElementById('dvHistPanelEmployees').classList.remove('dv-panel-active');

    var dvEl = document.getElementById('divisionViewHistory');
    dvEl.classList.add('dv-active');

    renderHistoryDivision();
}

/* =========================================================
   BACK TO DIVISION CARDS
   ========================================================= */
function backToDivisionsHistory() {
    document.getElementById('histDivisionCardsGrid').style.display = '';
    document.getElementById('divisionViewHistory').classList.remove('dv-active');
    activeHistDivisionKey = null;
}

/* =========================================================
   SUBTAB SWITCHER
   ========================================================= */
function switchHistSubtab(tab) {
    activeHistSubtab = tab;
    document.getElementById('dvHistTabGrouped').classList.toggle('active',   tab === 'grouped');
    document.getElementById('dvHistTabAll').classList.toggle('active',        tab === 'all');
    document.getElementById('dvHistTabEmp').classList.toggle('active',        tab === 'employees');
    document.getElementById('dvHistPanelGrouped').classList.toggle('dv-panel-active',   tab === 'grouped');
    document.getElementById('dvHistPanelAll').classList.toggle('dv-panel-active',        tab === 'all');
    document.getElementById('dvHistPanelEmployees').classList.toggle('dv-panel-active',  tab === 'employees');
    renderHistoryDivision();
}

/* =========================================================
   RENDER FUNCTION
   ========================================================= */
function renderHistoryDivision() {
    if (!activeHistDivisionKey) return;
    var div = HIST_DIVISIONS[activeHistDivisionKey];

    var unitFilter = document.getElementById('dvHistUnitFilter').value;
    var assets = div.assets.filter(a => !unitFilter || a.unit === unitFilter);

    document.getElementById('dvHistCount').textContent =
        assets.length + ' record' + (assets.length !== 1 ? 's' : '');

    if (activeHistSubtab === 'grouped')        renderHistGrouped(assets);
    else if (activeHistSubtab === 'all')       renderHistAll(assets);
    else                                       renderHistEmployees(assets);
}

/* ---- Render: Grouped by Same Maintenance Date ---- */
function renderHistGrouped(assets) {
    var panel = document.getElementById('dvHistPanelGrouped');

    if (!assets.length) { panel.innerHTML = dvEmptyState('No records match the selected filter.'); return; }

    // Group by date
    var groups = {};
    assets.forEach(a => {
        if (!groups[a.date]) groups[a.date] = [];
        groups[a.date].push(a);
    });

    var sortedDates = Object.keys(groups).sort().reverse(); // most recent first
    var multiGroups = sortedDates.filter(d => groups[d].length >= 2);

    if (!multiGroups.length) {
        panel.innerHTML = `
            <div class="dv-empty">
                <i class="fas fa-calendar-check"></i>
                <h4>No Shared Maintenance Dates</h4>
                <p>No equipment in this selection shares the same maintenance date. Switch to <strong>All Equipment</strong> to see individual records.</p>
            </div>`;
        return;
    }

    var iconMap  = { system_unit: 'fa-desktop', laptop: 'fa-laptop', printer: 'fa-print', monitor: 'fa-tv' };
    var typeClass = { system_unit: '', laptop: '', printer: 'type-printer', monitor: 'type-monitor' };
    var condMap  = { excellent: 'mnt-badge-excellent', good: 'mnt-badge-good', fair: 'mnt-badge-fair', poor: 'mnt-badge-poor' };

    var html = '';
    multiGroups.forEach(date => {
        var group = groups[date];
        var rep = group[0];

        html += `
        <div class="dv-date-group">
            <div class="dv-date-group-header">
                <div class="dv-date-group-marker"></div>
                <div class="dv-date-group-label">${rep.dateLabel}</div>
                <div class="dv-date-group-sublabel">Maintenance Date</div>
                <div class="dv-date-group-count"><i class="fas fa-tools"></i> ${group.length} Equipment</div>
            </div>
            <div class="dv-group-table-wrap">
                <table class="dv-group-table">
                    <thead>
                        <tr>
                            <th>Equipment</th>
                            <th>Unit / Section</th>
                            <th>Time</th>
                            <th>Technician</th>
                            <th>Condition</th>
                            <th>Report</th>
                        </tr>
                    </thead>
                    <tbody>`;

        group.forEach(a => {
            html += `
                        <tr>
                            <td>
                                <div class="mnt-equip-cell">
                                    <div class="mnt-equip-icon ${typeClass[a.type] || ''}"><i class="fas ${iconMap[a.type] || 'fa-desktop'}"></i></div>
                                    <div>
                                        <div class="mnt-equip-name">${a.name}</div>
                                        <div class="mnt-equip-serial">SN: ${a.serial}</div>
                                    </div>
                                </div>
                            </td>
                            <td><div class="mnt-location-primary">${a.unit}</div></td>
                            <td><div class="mnt-date-sub" style="font-size:var(--text-sm); color:var(--text-dark);">${a.time}</div></td>
                            <td>
                                <div class="mnt-tech-name">${a.tech}</div>
                                <div class="mnt-tech-role">${a.techRole}</div>
                            </td>
                            <td><span class="mnt-badge ${condMap[a.condition]}"><i class="fas fa-circle"></i> ${a.conditionLabel}</span></td>
                            <td><button class="mnt-btn-report" onclick="viewReport(${a.id})"><i class="fas fa-file-pdf"></i> View</button></td>
                        </tr>`;
        });

        html += `</tbody></table></div></div>`;
    });

    panel.innerHTML = html;
}

/* ---- Render: All Equipment (flat list) ---- */
function renderHistAll(assets) {
    var tbody = document.getElementById('dvHistAllBody');
    var iconMap  = { system_unit: 'fa-desktop', laptop: 'fa-laptop', printer: 'fa-print', monitor: 'fa-tv' };
    var typeClass = { system_unit: '', laptop: '', printer: 'type-printer', monitor: 'type-monitor' };
    var condMap  = { excellent: 'mnt-badge-excellent', good: 'mnt-badge-good', fair: 'mnt-badge-fair', poor: 'mnt-badge-poor' };

    if (!assets.length) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:var(--text-light); font-style:italic;">No records match the selected filter.</td></tr>`;
        return;
    }

    tbody.innerHTML = '';
    assets.sort((a, b) => b.date.localeCompare(a.date)); // most recent first

    assets.forEach(a => {
        tbody.innerHTML += `
            <tr>
                <td>
                    <div class="mnt-equip-cell">
                        <div class="mnt-equip-icon ${typeClass[a.type] || ''}"><i class="fas ${iconMap[a.type] || 'fa-desktop'}"></i></div>
                        <div>
                            <div class="mnt-equip-name">${a.name}</div>
                            <div class="mnt-equip-serial">SN: ${a.serial}</div>
                        </div>
                    </div>
                </td>
                <td><div class="mnt-location-primary">${a.unit}</div></td>
                <td>
                    <div class="mnt-tech-name">${a.tech}</div>
                    <div class="mnt-tech-role">${a.techRole}</div>
                </td>
                <td><div class="mnt-date-primary completed">${a.dateLabel}</div></td>
                <td><div class="mnt-date-sub" style="color:var(--text-dark); font-size:var(--text-sm);">${a.time}</div></td>
                <td><span class="mnt-badge ${condMap[a.condition]}"><i class="fas fa-circle"></i> ${a.conditionLabel}</span></td>
                <td><button class="mnt-btn-report" onclick="viewReport(${a.id})"><i class="fas fa-file-pdf"></i> View</button></td>
            </tr>`;
    });
}

/* ---- Render: By Employee ---- */
function renderHistEmployees(filteredAssets) {
    var grid = document.getElementById('dvHistEmpGrid');
    if (!activeHistDivisionKey) return;

    var unitFilter   = document.getElementById('dvHistUnitFilter').value;
    var allEmployees = HIST_EMPLOYEES[activeHistDivisionKey] || [];
    var filteredIds  = new Set(filteredAssets.map(a => a.id));

    // Build asset lookup
    var assetLookup = {};
    (HIST_DIVISIONS[activeHistDivisionKey].assets || []).forEach(a => assetLookup[a.id] = a);

    var iconMap   = { system_unit: 'fa-desktop', laptop: 'fa-laptop', printer: 'fa-print', monitor: 'fa-tv' };
    var typeClass = { system_unit: '', laptop: '', printer: 'type-printer', monitor: 'type-monitor' };
    var condMap   = { excellent: 'mnt-badge-excellent', good: 'mnt-badge-good', fair: 'mnt-badge-fair', poor: 'mnt-badge-poor' };
    var condChip  = { excellent: 'excellent', good: 'good', fair: 'fair', poor: 'poor' };
    var condIcon  = { excellent: 'fa-star', good: 'fa-check-circle', fair: 'fa-minus-circle', poor: 'fa-times-circle' };

    // Filter employees by unit, then only those with matching assets
    var employees = allEmployees.filter(e => !unitFilter || e.unit === unitFilter);
    employees = employees.filter(e => e.assets.some(id => filteredIds.has(id)));

    if (!employees.length) {
        grid.innerHTML = `<div class="dv-empty" style="grid-column:1/-1">
            <i class="fas fa-users"></i>
            <h4>No Employees Found</h4>
            <p>No employees match the selected unit filter.</p>
        </div>`;
        return;
    }

    var condOrder = { excellent: 4, good: 3, fair: 2, poor: 1 };

    var html = '';
    employees.forEach(emp => {
        var empAssets = emp.assets
            .filter(id => filteredIds.has(id))
            .map(id => assetLookup[id])
            .filter(Boolean);

        var maintained = empAssets.filter(a => a.condition !== 'pending').length;
        var pending    = empAssets.filter(a => a.condition === 'pending').length;
        var excellent  = empAssets.filter(a => a.condition === 'excellent').length;

        // Determine overall condition (worst asset drives accent bar)
        var hasPoor      = empAssets.some(a => a.condition === 'poor');
        var hasFair      = empAssets.some(a => a.condition === 'fair');
        var complianceClass = hasPoor ? 'compliance-low' : hasFair ? 'compliance-medium' : 'compliance-high';

        // Most recent maintenance date
        var sorted = [...empAssets].sort((a, b) => b.date.localeCompare(a.date));
        var lastDate = sorted.length ? sorted[0].dateLabel : '—';

        // Equipment rows (max 4)
        var shown = empAssets.slice(0, 4);
        var extra = empAssets.length - shown.length;

        var equipRows = '';
        shown.forEach(a => {
            var chipCls = condChip[a.condition] || 'pending';
            var chipIco = condIcon[a.condition]  || 'fa-question-circle';
            equipRows += `
                <div class="dv-emp-equip-row">
                    <div class="dv-emp-equip-icon ${typeClass[a.type] || ''}">
                        <i class="fas ${iconMap[a.type] || 'fa-desktop'}"></i>
                    </div>
                    <div class="dv-emp-equip-info">
                        <div class="dv-emp-equip-name">${a.name}</div>
                        <div class="dv-emp-equip-serial">${a.serial} &nbsp;·&nbsp; ${a.dateLabel}</div>
                    </div>
                    <span class="dv-emp-maint-chip ${chipCls}">
                        <i class="fas ${chipIco}"></i> ${a.conditionLabel}
                    </span>
                </div>`;
        });

        if (extra > 0) {
            equipRows += `<div class="dv-emp-no-equip">+${extra} more record${extra > 1 ? 's' : ''}</div>`;
        }

        // Compliance pill for footer
        var compRate = empAssets.length > 0
            ? Math.round((maintained / empAssets.length) * 100)
            : 0;
        var compColor = compRate >= 90 ? 'var(--color-success)' : compRate >= 70 ? 'var(--color-warning)' : 'var(--color-danger)';

        html += `
        <div class="dv-emp-card ${complianceClass}">
            <div class="dv-emp-card-header">
                <div class="dv-emp-avatar"><i class="fas fa-user"></i></div>
                <div class="dv-emp-identity">
                    <div class="dv-emp-name">${emp.name}</div>
                    <div class="dv-emp-meta">
                        <span class="dv-emp-position">${emp.position}</span>
                        <span class="dv-emp-unit-tag"><i class="fas fa-map-marker-alt"></i> ${emp.unit}</span>
                    </div>
                </div>
            </div>
            <div class="dv-emp-hist-stats">
                <div class="dv-emp-hist-stat">
                    <div class="dv-emp-hist-stat-num">${empAssets.length}</div>
                    <div class="dv-emp-hist-stat-lbl">Total</div>
                </div>
                <div class="dv-emp-hist-stat">
                    <div class="dv-emp-hist-stat-num is-maintained">${maintained}</div>
                    <div class="dv-emp-hist-stat-lbl">Maintained</div>
                </div>
                <div class="dv-emp-hist-stat">
                    <div class="dv-emp-hist-stat-num is-excellent">${excellent}</div>
                    <div class="dv-emp-hist-stat-lbl">Excellent</div>
                </div>
                <div class="dv-emp-hist-stat">
                    <div class="dv-emp-hist-stat-num ${pending > 0 ? 'is-pending' : 'zero'}">${pending}</div>
                    <div class="dv-emp-hist-stat-lbl">Pending</div>
                </div>
            </div>
            <div class="dv-emp-equip-list">${equipRows}</div>
            <div class="dv-emp-card-footer">
                <div class="dv-emp-last-maint">
                    <i class="fas fa-calendar-check"></i> Last: ${lastDate}
                </div>
                <span style="font-size:var(--text-xs); font-weight:700; color:${compColor};">
                    <i class="fas fa-chart-line"></i> ${compRate}% Compliance
                </span>
            </div>
        </div>`;
    });

    grid.innerHTML = html;
}

function dvEmptyState(msg) {
    return `<div class="dv-empty"><i class="fas fa-search"></i><h4>No Results</h4><p>${msg}</p></div>`;
}

function exportReport() {
    alert('Exporting maintenance history report...\n\nThis will generate an Excel file with:\n- Complete maintenance records\n- Technician summaries\n- Equipment condition trends\n- Compliance statistics');
}

function viewReport(recordId) {
    alert('Opening maintenance report #' + recordId + '...\n\nThis will display:\n- Detailed checklist results\n- Technician notes\n- Signatory information');
}